<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0" version="28.2.9">
  <diagram name="Backward Pass" id="backward-pass">
    <mxGraphModel dx="2011" dy="1180" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="2000" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="title" value="&lt;b&gt;Backward Pass (t=0, single timestep)&lt;/b&gt;&lt;br&gt;bs=128, N=256, a_dim=32" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;" parent="1" vertex="1">
          <mxGeometry x="600" y="20" width="400" height="40" as="geometry" />
        </mxCell>
        <mxCell id="step1_box" value="&lt;b&gt;Step 1: Accumulate Output Gradient&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="50" y="100" width="300" height="40" as="geometry" />
        </mxCell>
        <mxCell id="grad_output_tensor" value="grad_output[:, 0, :]&lt;br&gt;(128, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="50" y="160" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="grad_r_init" value="grad_r&lt;br&gt;(128, 256)&lt;br&gt;[initialized to 0]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="210" y="160" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="add1" value="+" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;fillColor=#f8cecc;strokeColor=#b85450;" parent="1" vertex="1">
          <mxGeometry x="175" y="240" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="arrow1a" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.25;entryY=0;" parent="1" source="grad_output_tensor" target="add1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow1b" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.75;entryY=0;" parent="1" source="grad_r_init" target="add1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="grad_r_updated" value="grad_r&lt;br&gt;(128, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="120" y="290" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="arrow1c" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="add1" target="grad_r_updated" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="step2_box" value="&lt;b&gt;Step 2: Gradient w.r.t. Activation Output&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="50" y="380" width="300" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mult_alpha" value="× α" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;fillColor=#f8cecc;strokeColor=#b85450;" parent="1" vertex="1">
          <mxGeometry x="175" y="440" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow2a" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="grad_r_updated" target="mult_alpha" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="grad_recurrent_activated" value="grad_recurrent_activated&lt;br&gt;(128, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="120" y="500" width="150" height="60" as="geometry" />
        </mxCell>
        <mxCell id="arrow2b" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="mult_alpha" target="grad_recurrent_activated" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="step3_box" value="&lt;b&gt;Step 3: Recompute W_eff (Forward Computation)&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="450" y="100" width="400" height="40" as="geometry" />
        </mxCell>
        <mxCell id="A_t" value="A_t = action_signal[:, 0, :]&lt;br&gt;(128, 32)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="450" y="160" width="180" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Wa_tensor" value="Wa&lt;br&gt;(32, 256, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="670" y="160" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="reshape1" value="view(32, 65536)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="670" y="240" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow3a" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="Wa_tensor" target="reshape1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Wa_flat" value="Wa_flat&lt;br&gt;(32, 65536)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="670" y="300" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="arrow3b" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="reshape1" target="Wa_flat" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="gemm1_label" value="&lt;b&gt;GEMM 1&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="580" y="300" width="60" height="20" as="geometry" />
        </mxCell>
        <mxCell id="gemm1_box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#FF6B6B;strokeWidth=2;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="440" y="380" width="360" height="100" as="geometry" />
        </mxCell>
        <mxCell id="gemm1_left" value="A_t&lt;br&gt;(128, 32)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="450" y="400" width="80" height="60" as="geometry" />
        </mxCell>
        <mxCell id="gemm1_top" value="Wa_flat&lt;br&gt;(32, 65536)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="550" y="390" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="gemm1_result" value="Wa_weighted_flat&lt;br&gt;(128, 65536)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="550" y="440" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow3c" value="" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;" parent="1" source="A_t" target="gemm1_left" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow3d" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="Wa_flat" target="gemm1_top" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="reshape2" value="view(128, 256, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="690" y="440" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow3e" value="" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;" parent="1" source="gemm1_result" target="reshape2" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Wa_weighted" value="Wa_weighted&lt;br&gt;(128, 256, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="680" y="500" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="arrow3f" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="reshape2" target="Wa_weighted" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="J0_tensor" value="J0&lt;br&gt;(256, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="450" y="520" width="100" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Wo_tensor" value="Wo&lt;br&gt;(256, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="570" y="520" width="90" height="60" as="geometry" />
        </mxCell>
        <mxCell id="J1_mult" value="J1 ×" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="600" y="590" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="arrow3g" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="Wo_tensor" target="J1_mult" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="sum_Weff" value="+" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;fillColor=#f8cecc;strokeColor=#b85450;" parent="1" vertex="1">
          <mxGeometry x="610" y="640" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow3h" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0;entryY=0.3;" parent="1" source="J0_tensor" target="sum_Weff" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow3i" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="J1_mult" target="sum_Weff" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow3j" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=1;entryY=0.3;" parent="1" source="Wa_weighted" target="sum_Weff" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="W_eff" value="W_eff&lt;br&gt;(128, 256, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="560" y="700" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="arrow3k" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="sum_Weff" target="W_eff" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="step4_box" value="&lt;b&gt;Step 4: Recompute recurrent_input&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="900" y="100" width="300" height="40" as="geometry" />
        </mxCell>
        <mxCell id="r_prev" value="r_prev = bump_history_full[:, 0, :]&lt;br&gt;(r_init)&lt;br&gt;(128, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="900" y="160" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="unsqueeze1" value="unsqueeze(2)&lt;br&gt;→ (128, 256, 1)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="960" y="240" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow4a" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="r_prev" target="unsqueeze1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="gemm2_label" value="&lt;b&gt;GEMM 2 (batched)&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="840" y="360" width="120" height="20" as="geometry" />
        </mxCell>
        <mxCell id="gemm2_box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#FF6B6B;strokeWidth=2;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="820" y="390" width="280" height="120" as="geometry" />
        </mxCell>
        <mxCell id="gemm2_left" value="W_eff&lt;br&gt;(128, 256, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="830" y="420" width="100" height="60" as="geometry" />
        </mxCell>
        <mxCell id="gemm2_top" value="r_prev&lt;br&gt;(128, 256, 1)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="950" y="400" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="gemm2_result" value="result&lt;br&gt;(128, 256, 1)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="950" y="450" width="80" height="50" as="geometry" />
        </mxCell>
        <mxCell id="arrow4b" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="W_eff" target="gemm2_left" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow4c" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="unsqueeze1" target="gemm2_top" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="squeeze1" value="squeeze(2)&lt;br&gt;→ (128, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="1040" y="460" width="90" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow4d" value="" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;" parent="1" source="gemm2_result" target="squeeze1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="recurrent_input" value="recurrent_input&lt;br&gt;(128, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="940" y="530" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="arrow4e" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=1;entryY=0.25;" parent="1" source="squeeze1" target="recurrent_input" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="step5_box" value="&lt;b&gt;Step 5: Gradient Through Activation&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="50" y="620" width="300" height="40" as="geometry" />
        </mxCell>
        <mxCell id="activation_deriv" value="non_linear_derivative()&lt;br&gt;(elementwise)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" parent="1" vertex="1">
          <mxGeometry x="105" y="680" width="190" height="50" as="geometry" />
        </mxCell>
        <mxCell id="arrow5a" value="" style="endArrow=classic;html=1;exitX=0;exitY=0.5;entryX=1;entryY=0.3;dashed=1;" parent="1" source="recurrent_input" target="activation_deriv" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow5b" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0;entryY=0.7;" parent="1" source="grad_recurrent_activated" target="activation_deriv" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="grad_recurrent_input" value="grad_recurrent_input&lt;br&gt;(128, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="120" y="760" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="arrow5c" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="activation_deriv" target="grad_recurrent_input" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="step6_box" value="&lt;b&gt;Step 6: Gradient w.r.t. r_{t-1}&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="900" y="640" width="300" height="40" as="geometry" />
        </mxCell>
        <mxCell id="W_eff_transpose" value="W_eff.transpose(1, 2)&lt;br&gt;(128, 256, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="900" y="700" width="150" height="60" as="geometry" />
        </mxCell>
        <mxCell id="arrow6a" value="" style="endArrow=classic;html=1;exitX=1;exitY=0.75;entryX=0;entryY=0.5;dashed=1;" parent="1" source="W_eff" target="W_eff_transpose" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="unsqueeze2" value="unsqueeze(2)&lt;br&gt;→ (128, 256, 1)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="1080" y="710" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow6b" value="" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0.5;entryY=0;dashed=1;" parent="1" source="grad_recurrent_input" target="unsqueeze2" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="gemm3_label" value="&lt;b&gt;GEMM 3 (batched)&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="880" y="790" width="120" height="20" as="geometry" />
        </mxCell>
        <mxCell id="gemm3_box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#FF6B6B;strokeWidth=2;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="860" y="820" width="280" height="120" as="geometry" />
        </mxCell>
        <mxCell id="gemm3_left" value="W_eff^T&lt;br&gt;(128, 256, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="870" y="850" width="100" height="60" as="geometry" />
        </mxCell>
        <mxCell id="gemm3_top" value="grad&lt;br&gt;(128, 256, 1)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="990" y="830" width="80" height="40" as="geometry" />
        </mxCell>
        <mxCell id="gemm3_result" value="result&lt;br&gt;(128, 256, 1)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="990" y="880" width="80" height="50" as="geometry" />
        </mxCell>
        <mxCell id="arrow6c" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="W_eff_transpose" target="gemm3_left" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow6d" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="unsqueeze2" target="gemm3_top" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="squeeze2" value="squeeze(2)&lt;br&gt;→ (128, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="1080" y="890" width="90" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow6e" value="" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;" parent="1" source="gemm3_result" target="squeeze2" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="grad_r_from_recurrent" value="grad_r_from_recurrent&lt;br&gt;(128, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1040" y="960" width="170" height="60" as="geometry" />
        </mxCell>
        <mxCell id="arrow6f" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="squeeze2" target="grad_r_from_recurrent" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="step7_box" value="&lt;b&gt;Step 7: Gradient w.r.t. W_eff&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="400" y="860" width="300" height="40" as="geometry" />
        </mxCell>
        <mxCell id="unsqueeze3" value="unsqueeze(2)&lt;br&gt;→ (128, 256, 1)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="350" y="920" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow7a" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0;entryY=0.5;dashed=1;" parent="1" source="grad_recurrent_input" target="unsqueeze3" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="unsqueeze4" value="unsqueeze(1)&lt;br&gt;→ (128, 1, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="480" y="920" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow7b" value="" style="endArrow=classic;html=1;exitX=0;exitY=0.75;entryX=0.5;entryY=0;dashed=1;" parent="1" source="r_prev" target="unsqueeze4" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="bmm_label" value="&lt;b&gt;BMM (outer product)&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="360" y="990" width="150" height="20" as="geometry" />
        </mxCell>
        <mxCell id="bmm_box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#4D96FF;strokeWidth=2;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="320" y="1020" width="290" height="120" as="geometry" />
        </mxCell>
        <mxCell id="bmm_left" value="grad&lt;br&gt;(128, 256, 1)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="330" y="1050" width="90" height="60" as="geometry" />
        </mxCell>
        <mxCell id="bmm_top" value="r_prev&lt;br&gt;(128, 1, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="440" y="1030" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="bmm_result" value="grad_W_eff&lt;br&gt;(128, 256, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="440" y="1080" width="120" height="50" as="geometry" />
        </mxCell>
        <mxCell id="arrow7c" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="unsqueeze3" target="bmm_left" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow7d" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="unsqueeze4" target="bmm_top" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="step8_box" value="&lt;b&gt;Step 8: Accumulate grad_Wo&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="400" y="1170" width="300" height="40" as="geometry" />
        </mxCell>
        <mxCell id="sum_batch" value="sum(dim=0)&lt;br&gt;→ (256, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="450" y="1230" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow8a" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="bmm_result" target="sum_batch" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="mult_J1" value="× J1" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="485" y="1290" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="arrow8b" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="sum_batch" target="mult_J1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="grad_Wo_accum" value="grad_Wo += &lt;br&gt;(256, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="440" y="1340" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="arrow8c" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="mult_J1" target="grad_Wo_accum" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="step9_box" value="&lt;b&gt;Step 9: Accumulate grad_Wa&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="50" y="1170" width="300" height="40" as="geometry" />
        </mxCell>
        <mxCell id="grad_Wa_weighted_flat" value="grad_W_eff.view(128, 65536)&lt;br&gt;(128, 65536)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="50" y="1230" width="190" height="60" as="geometry" />
        </mxCell>
        <mxCell id="arrow9a" value="" style="endArrow=classic;html=1;exitX=0;exitY=0.75;entryX=0.5;entryY=0;dashed=1;" parent="1" source="bmm_result" target="grad_Wa_weighted_flat" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="gemm4_label" value="&lt;b&gt;GEMM 4&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" parent="1" vertex="1">
          <mxGeometry x="90" y="1320" width="60" height="20" as="geometry" />
        </mxCell>
        <mxCell id="gemm4_box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#FF6B6B;strokeWidth=2;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="30" y="1350" width="290" height="100" as="geometry" />
        </mxCell>
        <mxCell id="A_t_transpose" value="A_t^T&lt;br&gt;(32, 128)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="40" y="1380" width="80" height="60" as="geometry" />
        </mxCell>
        <mxCell id="gemm4_top" value="grad&lt;br&gt;(128, 65536)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="140" y="1360" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="gemm4_result" value="grad_Wa_flat&lt;br&gt;(32, 65536)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="140" y="1410" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow9b" value="" style="endArrow=classic;html=1;exitX=0;exitY=0.75;entryX=0.5;entryY=0;dashed=1;" parent="1" source="A_t" target="A_t_transpose" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow9c" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="grad_Wa_weighted_flat" target="gemm4_top" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="reshape_Wa_grad" value="view(32, 256, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="250" y="1420" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="arrow9d" value="" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;" parent="1" source="gemm4_result" target="reshape_Wa_grad" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="grad_Wa_accum" value="grad_Wa += &lt;br&gt;(32, 256, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="120" y="1480" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="arrow9e" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.75;entryY=0;" parent="1" source="reshape_Wa_grad" target="grad_Wa_accum" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="step10_box" value="&lt;b&gt;Step 10: Propagate grad_r&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="900" y="1070" width="300" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mult_decay" value="× (1-α)" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;fillColor=#f8cecc;strokeColor=#b85450;fontSize=9;" parent="1" vertex="1">
          <mxGeometry x="1010" y="1130" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow10a" value="" style="endArrow=classic;html=1;exitX=0;exitY=0.25;entryX=0.5;entryY=0;dashed=1;" parent="1" source="grad_r_updated" target="mult_decay" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="add_final" value="+" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;fillColor=#f8cecc;strokeColor=#b85450;" parent="1" vertex="1">
          <mxGeometry x="1055" y="1050" width="40" height="40" as="geometry" />
        </mxCell>
        <mxCell id="arrow10b" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0;entryY=0.5;" parent="1" source="grad_r_from_recurrent" target="add_final" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow10c" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;" parent="1" source="mult_decay" target="add_final" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="grad_r_next" value="grad_r (next iteration)&lt;br&gt;(128, 256)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1110" y="1040" width="170" height="60" as="geometry" />
        </mxCell>
        <mxCell id="arrow10d" value="" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;" parent="1" source="add_final" target="grad_r_next" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        <mxCell id="legend_box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="1250" y="100" width="300" height="280" as="geometry" />
        </mxCell>
        <mxCell id="legend_title" value="&lt;b&gt;Legend&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;" parent="1" vertex="1">
          <mxGeometry x="1350" y="110" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="legend1" value="Input/Saved Tensors" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1270" y="150" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="legend2" value="Intermediate Values" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1410" y="150" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="legend3" value="Gradient Tensors" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1270" y="190" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="legend4" value="Accumulated Gradients" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1410" y="190" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="legend5" value="Operations" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" parent="1" vertex="1">
          <mxGeometry x="1270" y="230" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="legend6" value="Reshape/View" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="1410" y="230" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="legend7" value="GEMM = General Matrix Multiply" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1270" y="270" width="260" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend8" value="BMM = Batched Matrix Multiply" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1270" y="290" width="260" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend9" value="Dashed boxes = grouped operations" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1270" y="310" width="260" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend10" value="Dashed arrows = reused from forward" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1270" y="330" width="260" height="20" as="geometry" />
        </mxCell>
        <mxCell id="summary_box" value="&lt;b&gt;Key GEMM Operations:&lt;/b&gt;&lt;br&gt;1. A_t @ Wa_flat → (128,32) @ (32,65536) = (128,65536)&lt;br&gt;2. W_eff @ r_prev → (128,256,256) @ (128,256,1) = (128,256,1)&lt;br&gt;3. W_eff^T @ grad → (128,256,256) @ (128,256,1) = (128,256,1)&lt;br&gt;4. A_t^T @ grad_flat → (32,128) @ (128,65536) = (32,65536)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="50" y="1580" width="450" height="90" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
